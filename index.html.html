<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDP Program - Referral Management System with AI Assistant</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        /* Login Screen Styles */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .login-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 36px;
            font-weight: bold;
            margin: 0 auto 20px;
        }

        .login-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .login-subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .login-input {
            padding: 15px 20px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        .login-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .login-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .login-error {
            color: #ef4444;
            font-size: 14px;
            display: none;
        }

        /* Main App Styles */
        .app-container {
            display: none;
            min-height: 100vh;
            padding: 20px;
        }

        .app-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .app-title {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-tabs {
            display: flex;
            gap: 5px;
            background: rgba(102, 126, 234, 0.1);
            padding: 5px;
            border-radius: 12px;
        }

        .nav-tab {
            background: transparent;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #667eea;
            font-size: 14px;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(102, 126, 234, 0.1);
        }

        .logout-btn {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 2px solid rgba(239, 68, 68, 0.2);
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #ef4444;
            color: white;
        }

        .content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            min-height: 600px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard Styles */
        .dashboard-header {
            margin-bottom: 30px;
            text-align: center;
        }

        .dashboard-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .dashboard-subtitle {
            color: #666;
            font-size: 16px;
        }

        .filters-section {
            background: rgba(102, 126, 234, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .filters-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: #667eea;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .filter-group select {
            padding: 10px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            background: white;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            border: 1px solid rgba(102, 126, 234, 0.1);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 36px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 14px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .chart-card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .chart-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
            text-align: center;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Referrals Styles */
        .referrals-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .referrals-title {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .search-box {
            width: 100%;
            max-width: 400px;
            padding: 12px 20px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 10px;
            font-size: 14px;
            margin-bottom: 20px;
            transition: border-color 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }

        .referrals-grid {
            display: grid;
            gap: 20px;
        }

        .referral-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid rgba(102, 126, 234, 0.1);
            transition: all 0.3s ease;
        }

        .referral-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .referral-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .referral-id {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
        }

        .referral-date {
            color: #666;
            font-size: 14px;
        }

        .referral-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .detail-label {
            font-weight: 600;
            color: #333;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            color: #666;
            font-size: 14px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge.accepted {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .badge.pending {
            background: rgba(251, 191, 36, 0.1);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.2);
        }

        .badge.rejected {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .badge.activated {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .referral-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-secondary {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border: 2px solid rgba(102, 126, 234, 0.2);
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 2px solid rgba(239, 68, 68, 0.2);
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
        }

        .btn-danger:hover {
            background: #ef4444;
            color: white;
        }

        .btn-cancel {
            background: rgba(107, 114, 128, 0.1);
            color: #6b7280;
            border: 2px solid rgba(107, 114, 128, 0.2);
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-cancel:hover {
            background: #6b7280;
            color: white;
        }

        /* AI Assistant Styles */
        .ai-assistant-header {
            margin-bottom: 30px;
            text-align: center;
        }

        .ai-assistant-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .ai-assistant-subtitle {
            color: #666;
            font-size: 16px;
        }

        .ai-container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* Suggested Questions */
        .suggested-questions {
            margin-bottom: 30px;
        }

        .suggested-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .suggested-questions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }

        .suggested-question {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 8px;
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            text-align: center;
        }

        .suggested-question:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        /* Chat Interface */
        .chat-container {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.1);
            height: 500px;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
            background: rgba(102, 126, 234, 0.05);
            border-radius: 12px 12px 0 0;
        }

        .chat-title {
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.4;
        }

        .message.user {
            align-self: flex-end;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .message.ai {
            align-self: flex-start;
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
            color: #333;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
        }

        .typing-indicator {
            align-self: flex-start;
            padding: 12px 16px;
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 12px;
            max-width: 80px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: typingDot 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        .chat-input-container {
            padding: 20px;
            border-top: 1px solid rgba(102, 126, 234, 0.1);
            background: rgba(102, 126, 234, 0.02);
            border-radius: 0 0 12px 12px;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 8px;
            font-size: 14px;
            resize: none;
            min-height: 40px;
            max-height: 120px;
            transition: border-color 0.3s ease;
        }

        .chat-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .chat-send-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .chat-send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .chat-send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Client Matrix Styles */
        .matrix-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .matrix-title {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-export {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            border: 2px solid rgba(34, 197, 94, 0.2);
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-export:hover {
            background: #22c55e;
            color: white;
        }

        .matrix-content {
            display: grid;
            gap: 30px;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .analytics-card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .analytics-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .progress-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .progress-bar {
            width: 60%;
            height: 8px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .client-table {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(102, 126, 234, 0.1);
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
        }

        .table th {
            background: rgba(102, 126, 234, 0.05);
            font-weight: 600;
            color: #333;
        }

        .table tr:hover {
            background: rgba(102, 126, 234, 0.02);
        }

        /* Settings Styles */
        .settings-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .settings-subtitle {
            color: #666;
            font-size: 16px;
            margin-bottom: 30px;
        }

        .settings-section {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .section-title {
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .add-field-form {
            display: grid;
            grid-template-columns: 1fr 2fr auto;
            gap: 15px;
            align-items: end;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-group select,
        .form-group input {
            padding: 10px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .field-values {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .field-value-item {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 20px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .field-value-actions {
            display: flex;
            gap: 5px;
        }

        .field-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px;
            border-radius: 3px;
            transition: background 0.3s ease;
            font-size: 12px;
        }

        .field-action-btn:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        .field-action-btn.delete:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        /* Modal Styles - FIXED VERSION */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
            padding: 20px;
            box-sizing: border-box;
        }

        .modal {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 95vw;
            width: 100%;
            max-height: 95vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        /* Responsive modal sizing */
        @media (min-width: 768px) {
            .modal {
                max-width: 900px;
                max-height: 90vh;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.3s ease;
            min-width: 40px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (min-width: 768px) {
            .form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .form-section {
            border: 1px solid rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            padding: 20px;
            background: rgba(102, 126, 234, 0.02);
        }

        .form-section-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        @media (min-width: 480px) {
            .form-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .form-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-field label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-field input,
        .form-field select,
        .form-field textarea {
            padding: 12px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-field input:focus,
        .form-field select:focus,
        .form-field textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-field input:disabled {
            background: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }

        .form-field small {
            color: #666;
            font-size: 12px;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        @keyframes typingDot {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .app-header {
                padding: 15px 20px;
            }

            .app-title {
                font-size: 24px;
            }

            .nav-tabs {
                width: 100%;
                justify-content: center;
            }

            .nav-tab {
                padding: 10px 16px;
                font-size: 12px;
            }

            .content {
                padding: 20px;
            }

            .dashboard-title,
            .referrals-title,
            .matrix-title,
            .settings-title,
            .ai-assistant-title {
                font-size: 24px;
            }

            .referrals-header {
                flex-direction: column;
                align-items: stretch;
            }

            .matrix-header {
                flex-direction: column;
                align-items: stretch;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .chart-card {
                min-width: 0;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }

            .referral-details {
                grid-template-columns: 1fr;
            }

            .add-field-form {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .suggested-questions-grid {
                grid-template-columns: 1fr;
            }

            .modal {
                padding: 20px;
                margin: 10px;
            }

            .modal-title {
                font-size: 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .modal-actions {
                justify-content: stretch;
            }

            .modal-actions button {
                flex: 1;
            }
        }

        @media (max-width: 480px) {
            .app-container {
                padding: 10px;
            }

            .nav-tab {
                padding: 8px 12px;
                font-size: 11px;
            }

            .content {
                padding: 15px;
            }

            .stat-card {
                padding: 20px;
            }

            .referral-card {
                padding: 20px;
            }

            .modal {
                padding: 15px;
                margin: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-container">
            <div class="login-logo">CDP</div>
            <h1 class="login-title">CDP Program</h1>
            <p class="login-subtitle">Referral Management System</p>
            <form class="login-form" onsubmit="login(event)">
                <input 
                    type="password" 
                    class="login-input" 
                    id="passwordInput" 
                    placeholder="Enter password" 
                    required
                >
                <button type="submit" class="login-btn">Access System</button>
                <div class="login-error" id="loginError">
                    Incorrect password. Please try again.
                </div>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div class="app-container" id="appContainer">
        <header class="app-header">
            <h1 class="app-title">CDP Program - Referral Management System</h1>
            <nav class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('dashboard')">Dashboard</button>
                <button class="nav-tab" onclick="showTab('referrals')">Referrals</button>
                <button class="nav-tab" onclick="showTab('ai-assistant')">ü§ñ AI Assistant</button>
                <button class="nav-tab" onclick="showTab('matrix')">Client Matrix</button>
                <button class="nav-tab" onclick="showTab('settings')">Settings</button>
            </nav>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </header>

        <main class="content">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <div class="dashboard-header">
                    <h2 class="dashboard-title">Dashboard</h2>
                    <p class="dashboard-subtitle">Overview of referral metrics and analytics</p>
                </div>

                <div class="filters-section">
                    <h3 class="filters-title">üîç Filters</h3>
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label>Time Period</label>
                            <select id="timePeriodFilter" onchange="updateDashboard()">
                                <option value="all">All Time</option>
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                                <option value="year">This Year</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Gender</label>
                            <select id="genderFilter" onchange="updateDashboard()">
                                <option value="all">All Genders</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Referral Source</label>
                            <select id="sourceFilter" onchange="updateDashboard()">
                                <option value="all">All Sources</option>
                                <option value="SAPOL">SAPOL</option>
                                <option value="ALRM">ALRM</option>
                                <option value="ACCO">ACCO</option>
                                <option value="School">School</option>
                                <option value="Kurlana Tapa">Kurlana Tapa</option>
                                <option value="Courts">Courts</option>
                                <option value="Community Youth Justice">Community Youth Justice</option>
                                <option value="DCP">DCP</option>
                                <option value="Family">Family</option>
                                <option value="NGO">NGO</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalReferrals">0</div>
                        <div class="stat-label">Total Referrals</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="acceptedReferrals">0</div>
                        <div class="stat-label">Accepted Referrals</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="pendingReferrals">0</div>
                        <div class="stat-label">Pending Referrals</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeSupport">0</div>
                        <div class="stat-label">Active Support</div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-card">
                        <h3 class="chart-title">Gender Distribution</h3>
                        <div class="chart-container">
                            <canvas id="genderChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3 class="chart-title">Age Groups</h3>
                        <div class="chart-container">
                            <canvas id="ageChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3 class="chart-title">Referral Sources</h3>
                        <div class="chart-container">
                            <canvas id="sourceChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3 class="chart-title">Monthly Trend</h3>
                        <div class="chart-container">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Referrals Tab -->
            <div id="referrals" class="tab-content">
                <div class="referrals-header">
                    <h2 class="referrals-title">Referrals Management</h2>
                    <button class="btn-primary" onclick="showNewReferralForm()">+ New Referral</button>
                </div>

                <input type="text" class="search-box" id="referralSearch" placeholder="Search referrals..." onkeyup="filterReferrals()">

                <div class="referrals-grid" id="referralsGrid">
                    <!-- Referral cards will be populated here -->
                </div>
            </div>

            <!-- AI Assistant Tab -->
            <div id="ai-assistant" class="tab-content">
                <div class="ai-assistant-header">
                    <h2 class="ai-assistant-title">AI Assistant</h2>
                    <p class="ai-assistant-subtitle">Ask questions about your referral data and get intelligent insights</p>
                </div>

                <div class="ai-container">
                    <!-- Suggested Questions -->
                    <div class="suggested-questions">
                        <h3 class="suggested-title">üí° Suggested Questions</h3>
                        <div class="suggested-questions-grid">
                            <div class="suggested-question" onclick="askQuestion('How many referrals do we have in total?')">
                                How many referrals do we have in total?
                            </div>
                            <div class="suggested-question" onclick="askQuestion('What are the most common referral sources?')">
                                What are the most common referral sources?
                            </div>
                            <div class="suggested-question" onclick="askQuestion('Show me the age breakdown of our clients')">
                                Show me the age breakdown of our clients
                            </div>
                            <div class="suggested-question" onclick="askQuestion('Which support types are used most frequently?')">
                                Which support types are used most frequently?
                            </div>
                            <div class="suggested-question" onclick="askQuestion('How many cases are currently open vs closed?')">
                                How many cases are currently open vs closed?
                            </div>
                            <div class="suggested-question" onclick="askQuestion('What is the average age of our clients?')">
                                What is the average age of our clients?
                            </div>
                        </div>
                    </div>

                    <!-- Chat Interface -->
                    <div class="chat-container">
                        <div class="chat-header">
                            <h3 class="chat-title">üí¨ Chat with AI Assistant</h3>
                        </div>
                        <div class="chat-messages" id="chatMessages">
                            <div class="message ai">
                                <div>Hello! I'm your AI assistant. I can help you analyze your referral data and answer questions about your clients, outcomes, and trends. What would you like to know?</div>
                                <div class="message-time">Just now</div>
                            </div>
                        </div>
                        <div class="chat-input-container">
                            <div class="chat-input-wrapper">
                                <textarea 
                                    class="chat-input" 
                                    id="chatInput" 
                                    placeholder="Ask me anything about your referral data..."
                                    onkeydown="handleChatKeydown(event)"
                                ></textarea>
                                <button class="chat-send-btn" id="chatSendBtn" onclick="sendMessage()">Send</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Client Matrix Tab -->
            <div id="matrix" class="tab-content">
                <div class="matrix-header">
                    <h2 class="matrix-title">Client Matrix Report</h2>
                    <div class="export-buttons">
                        <button class="btn-export" onclick="exportToExcel()">üìä Export to Excel</button>
                        <button class="btn-export" onclick="exportToCSV()">üìÑ Export to CSV</button>
                    </div>
                </div>

                <div class="matrix-content">
                    <!-- Analytics Cards -->
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <h3 class="analytics-title">üìä Demographics Overview</h3>
                            <div class="progress-item">
                                <span>Male</span>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 60%"></div>
                                </div>
                                <span>60%</span>
                            </div>
                            <div class="progress-item">
                                <span>Female</span>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 40%"></div>
                                </div>
                                <span>40%</span>
                            </div>
                            <div class="progress-item">
                                <span>Age 16-17</span>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 70%"></div>
                                </div>
                                <span>70%</span>
                            </div>
                        </div>

                        <div class="analytics-card">
                            <h3 class="analytics-title">üéØ Referral Outcomes</h3>
                            <div class="progress-item">
                                <span>Accepted</span>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 80%"></div>
                                </div>
                                <span>80%</span>
                            </div>
                            <div class="progress-item">
                                <span>Criteria not Met</span>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 15%"></div>
                                </div>
                                <span>15%</span>
                            </div>
                            <div class="progress-item">
                                <span>Other Agencies</span>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 5%"></div>
                                </div>
                                <span>5%</span>
                            </div>
                        </div>

                        <div class="analytics-card">
                            <h3 class="analytics-title">üè† Living Arrangements</h3>
                            <div class="progress-item">
                                <span>With Family</span>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 50%"></div>
                                </div>
                                <span>50%</span>
                            </div>
                            <div class="progress-item">
                                <span>Residential Care</span>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 30%"></div>
                                </div>
                                <span>30%</span>
                            </div>
                            <div class="progress-item">
                                <span>Other</span>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 20%"></div>
                                </div>
                                <span>20%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Client Data Table -->
                    <div class="client-table">
                        <h3 class="analytics-title">üìã Complete Client Data</h3>
                        <table class="table" id="clientTable">
                            <thead>
                                <tr>
                                    <th>Referral ID</th>
                                    <th>Date</th>
                                    <th>Client Name</th>
                                    <th>Age</th>
                                    <th>Gender</th>
                                    <th>Post Code</th>
                                    <th>Living Arrangement</th>
                                    <th>NDIS Status</th>
                                    <th>Referral Source</th>
                                    <th>YJ Involvement</th>
                                    <th>Outcome</th>
                                    <th>Support Provided</th>
                                </tr>
                            </thead>
                            <tbody id="clientTableBody">
                                <!-- Table rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <h2 class="settings-title">Settings</h2>
                <p class="settings-subtitle">Manage field configurations and system settings</p>

                <div class="settings-section">
                    <h3 class="section-title">‚öôÔ∏è Field Management</h3>
                    
                    <div class="add-field-form">
                        <div class="form-group">
                            <label>Field Category</label>
                            <select id="fieldCategory">
                                <option value="livingArrangements">Living Arrangements</option>
                                <option value="referralSources">Referral Sources</option>
                                <option value="yjInvolvement">YJ Involvement</option>
                                <option value="referralOutcomes">Referral Outcomes</option>
                                <option value="supportProvided">Support Provided</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>New Value</label>
                            <input type="text" id="newFieldValue" placeholder="Enter new value">
                        </div>
                        <button class="btn-primary" onclick="addFieldValue()">+ Add New Value</button>
                    </div>

                    <div class="add-field-form">
                        <div class="form-group">
                            <label>Field Name</label>
                            <input type="text" id="newFieldName" placeholder="Enter field name">
                        </div>
                        <div class="form-group">
                            <label>Field Type</label>
                            <select id="newFieldType">
                                <option value="text">Text Field</option>
                                <option value="list">List Field</option>
                            </select>
                        </div>
                        <button class="btn-primary" onclick="addNewField()">+ Add New Field</button>
                    </div>

                    <!-- Living Arrangements -->
                    <div class="field-section">
                        <h4>üè† Living Arrangements</h4>
                        <div class="field-values" id="livingArrangementsValues">
                            <!-- Values will be populated here -->
                        </div>
                    </div>

                    <!-- Referral Sources -->
                    <div class="field-section">
                        <h4>üìû Referral Sources</h4>
                        <div class="field-values" id="referralSourcesValues">
                            <!-- Values will be populated here -->
                        </div>
                    </div>

                    <!-- YJ Involvement -->
                    <div class="field-section">
                        <h4>‚öñÔ∏è YJ Involvement</h4>
                        <div class="field-values" id="yjInvolvementValues">
                            <!-- Values will be populated here -->
                        </div>
                    </div>

                    <!-- Referral Outcomes -->
                    <div class="field-section">
                        <h4>üéØ Referral Outcomes</h4>
                        <div class="field-values" id="referralOutcomesValues">
                            <!-- Values will be populated here -->
                        </div>
                    </div>

                    <!-- Support Provided -->
                    <div class="field-section">
                        <h4>ü§ù Support Provided</h4>
                        <div class="field-values" id="supportProvidedValues">
                            <!-- Values will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Global variables
        let charts = {};
        let referralData = [];
        let currentReferralId = null;

        // Field configuration
        const fieldConfig = {
            livingArrangements: ['With family', 'Guardianship', 'Homeless', 'Residential care', 'In Custody', 'Care of DCP'],
            referralSources: ['SAPOL', 'ALRM', 'ACCO', 'School', 'Kurlana Tapa', 'Courts', 'Community Youth Justice', 'DCP', 'Family', 'NGO'],
            yjInvolvement: ['None', 'Past Mandates', 'Detained at KT', 'Community Supervision'],
            referralOutcomes: ['Accepted', 'Criteria not Met', 'Referred to Other Agencies', 'Referral not progressed'],
            supportProvided: ['Activated', 'Transport to country', 'Metro transport', 'Family Scoping and transport', 'Family scoping only', 'Supplementary support', 'Not applicable']
        };

        // Dummy data
        const dummyReferrals = [
            {
                id: 'REF-0001',
                referralDate: '15/01/2024',
                c3msNumber: 'C3MS001',
                clientName: 'Alex Johnson',
                dateOfBirth: '05/03/2008',
                ageAtReferral: 16,
                gender: 'Male',
                postCode: '5000',
                livingArrangement: 'With family',
                ndisStatus: 'Yes',
                referralSource: 'SAPOL',
                yjInvolvement: 'Past Mandates',
                referralOutcome: 'Accepted',
                supportProvided: 'Activated',
                events: []
            },
            {
                id: 'REF-0002',
                referralDate: '22/01/2024',
                c3msNumber: 'C3MS002',
                clientName: 'Sarah Williams',
                dateOfBirth: '12/07/2007',
                ageAtReferral: 17,
                gender: 'Female',
                postCode: '5001',
                livingArrangement: 'Residential care',
                ndisStatus: 'No',
                referralSource: 'DCP',
                yjInvolvement: 'Community Supervision',
                referralOutcome: 'Accepted',
                supportProvided: 'Transport to country',
                events: []
            },
            {
                id: 'REF-0003',
                referralDate: '28/01/2024',
                c3msNumber: 'C3MS003',
                clientName: 'Michael Brown',
                dateOfBirth: '18/11/2006',
                ageAtReferral: 17,
                gender: 'Male',
                postCode: '5002',
                livingArrangement: 'With family',
                ndisStatus: 'Unknown',
                referralSource: 'School',
                yjInvolvement: 'None',
                referralOutcome: 'Criteria not Met',
                supportProvided: 'Not applicable',
                events: []
            },
            {
                id: 'REF-0004',
                referralDate: '05/02/2024',
                c3msNumber: 'C3MS004',
                clientName: 'Emma Davis',
                dateOfBirth: '25/09/2008',
                ageAtReferral: 15,
                gender: 'Female',
                postCode: '5003',
                livingArrangement: 'Guardianship',
                ndisStatus: 'Yes',
                referralSource: 'Courts',
                yjInvolvement: 'Detained at KT',
                referralOutcome: 'Accepted',
                supportProvided: 'Family Scoping and transport',
                events: []
            },
            {
                id: 'REF-0005',
                referralDate: '12/02/2024',
                c3msNumber: 'C3MS005',
                clientName: 'James Wilson',
                dateOfBirth: '03/04/2007',
                ageAtReferral: 16,
                gender: 'Male',
                postCode: '5004',
                livingArrangement: 'In Custody',
                ndisStatus: 'No',
                referralSource: 'Community Youth Justice',
                yjInvolvement: 'Community Supervision',
                referralOutcome: 'Accepted',
                supportProvided: 'Metro transport',
                events: []
            },
            {
                id: 'REF-0006',
                referralDate: '19/02/2024',
                c3msNumber: 'C3MS006',
                clientName: 'Olivia Taylor',
                dateOfBirth: '14/12/2008',
                ageAtReferral: 15,
                gender: 'Female',
                postCode: '5005',
                livingArrangement: 'Care of DCP',
                ndisStatus: 'Yes',
                referralSource: 'Family',
                yjInvolvement: 'Past Mandates',
                referralOutcome: 'Referred to Other Agencies',
                supportProvided: 'Not applicable',
                events: []
            },
            {
                id: 'REF-0007',
                referralDate: '26/02/2024',
                c3msNumber: 'C3MS007',
                clientName: 'Daniel Anderson',
                dateOfBirth: '08/06/2006',
                ageAtReferral: 17,
                gender: 'Male',
                postCode: '5006',
                livingArrangement: 'Homeless',
                ndisStatus: 'Unknown',
                referralSource: 'NGO',
                yjInvolvement: 'None',
                referralOutcome: 'Accepted',
                supportProvided: 'Family scoping only',
                events: []
            },
            {
                id: 'REF-0008',
                referralDate: '05/03/2024',
                c3msNumber: 'C3MS008',
                clientName: 'Sophie Martinez',
                dateOfBirth: '21/01/2007',
                ageAtReferral: 17,
                gender: 'Female',
                postCode: '5007',
                livingArrangement: 'With family',
                ndisStatus: 'No',
                referralSource: 'ALRM',
                yjInvolvement: 'Community Supervision',
                referralOutcome: 'Accepted',
                supportProvided: 'Supplementary support',
                events: []
            },
            {
                id: 'REF-0009',
                referralDate: '12/03/2024',
                c3msNumber: 'C3MS009',
                clientName: 'Ryan Thompson',
                dateOfBirth: '30/10/2005',
                ageAtReferral: 18,
                gender: 'Male',
                postCode: '5008',
                livingArrangement: 'Residential care',
                ndisStatus: 'Yes',
                referralSource: 'Kurlana Tapa',
                yjInvolvement: 'Detained at KT',
                referralOutcome: 'Referral not progressed',
                supportProvided: 'Not applicable',
                events: []
            },
            {
                id: 'REF-0010',
                referralDate: '19/03/2024',
                c3msNumber: 'C3MS010',
                clientName: 'Chloe Garcia',
                dateOfBirth: '16/08/2008',
                ageAtReferral: 15,
                gender: 'Female',
                postCode: '5009',
                livingArrangement: 'With family',
                ndisStatus: 'No',
                referralSource: 'ACCO',
                yjInvolvement: 'Past Mandates',
                referralOutcome: 'Accepted',
                supportProvided: 'Activated',
                events: []
            }
        ];

        // Login functionality
        function login(event) {
            event.preventDefault();
            const password = document.getElementById('passwordInput').value;
            const errorDiv = document.getElementById('loginError');
            
            if (password === 'MarniWodli') {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                initializeApp();
            } else {
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 3000);
            }
        }

        function logout() {
            document.getElementById('loginOverlay').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('passwordInput').value = '';
        }

        // Initialize application
        function initializeApp() {
            referralData = [...dummyReferrals];
            renderSettings();
            renderReferrals();
            renderClientMatrix();
            updateDashboard();
            initializeCharts();
        }

        // Tab functionality
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked nav tab
            event.target.classList.add('active');
        }

        // Utility functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB');
        }

        function convertDate(ddmmyyyy) {
            const parts = ddmmyyyy.split('/');
            return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
        }

        function calculateAge() {
            const dobInput = document.getElementById('dateOfBirth');
            const referralDateInput = document.getElementById('referralDate');
            const ageInput = document.getElementById('ageAtReferral');
            
            if (dobInput.value && referralDateInput.value) {
                const dob = new Date(dobInput.value);
                const referralDate = new Date(referralDateInput.value);
                const age = Math.floor((referralDate - dob) / (365.25 * 24 * 60 * 60 * 1000));
                ageInput.value = age;
            }
        }

        // FIXED: Dashboard functionality with proper filtering
        function getFilteredData() {
            const timePeriod = document.getElementById('timePeriodFilter').value;
            const gender = document.getElementById('genderFilter').value;
            const source = document.getElementById('sourceFilter').value;
            
            let filteredData = [...referralData];
            
            // Apply time period filter
            if (timePeriod !== 'all') {
                const now = new Date();
                const cutoffDate = new Date();
                
                switch (timePeriod) {
                    case 'month':
                        cutoffDate.setMonth(now.getMonth() - 1);
                        break;
                    case 'quarter':
                        cutoffDate.setMonth(now.getMonth() - 3);
                        break;
                    case 'year':
                        cutoffDate.setFullYear(now.getFullYear() - 1);
                        break;
                }
                
                filteredData = filteredData.filter(r => {
                    const referralDate = new Date(convertDate(r.referralDate));
                    return referralDate >= cutoffDate;
                });
            }
            
            // Apply gender filter
            if (gender !== 'all') {
                filteredData = filteredData.filter(r => r.gender === gender);
            }
            
            // Apply source filter
            if (source !== 'all') {
                filteredData = filteredData.filter(r => r.referralSource === source);
            }
            
            return filteredData;
        }

        function updateDashboard() {
            const filteredData = getFilteredData();
            
            // Update KPI cards with filtered data
            document.getElementById('totalReferrals').textContent = filteredData.length;
            document.getElementById('acceptedReferrals').textContent = filteredData.filter(r => r.referralOutcome === 'Accepted').length;
            document.getElementById('pendingReferrals').textContent = filteredData.filter(r => r.referralOutcome === 'Referral not progressed').length;
            document.getElementById('activeSupport').textContent = filteredData.filter(r => r.supportProvided !== 'Not applicable').length;
            
            // Update charts if they exist
            if (Object.keys(charts).length > 0) {
                updateChartsWithFilteredData(filteredData);
            }
        }

        function initializeCharts() {
            const filteredData = getFilteredData();
            
            // Gender Distribution Chart
            const genderCtx = document.getElementById('genderChart').getContext('2d');
            const genderCounts = { Male: 0, Female: 0, Other: 0 };
            filteredData.forEach(r => genderCounts[r.gender]++);
            
            charts.gender = new Chart(genderCtx, {
                type: 'pie',
                data: {
                    labels: ['Male', 'Female', 'Other'],
                    datasets: [{
                        data: [genderCounts.Male, genderCounts.Female, genderCounts.Other],
                        backgroundColor: ['#667eea', '#764ba2', '#f093fb']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Age Groups Chart
            const ageCtx = document.getElementById('ageChart').getContext('2d');
            const ageCounts = { '14-15': 0, '16-17': 0, '18+': 0 };
            filteredData.forEach(r => {
                if (r.ageAtReferral <= 15) ageCounts['14-15']++;
                else if (r.ageAtReferral <= 17) ageCounts['16-17']++;
                else ageCounts['18+']++;
            });
            
            charts.age = new Chart(ageCtx, {
                type: 'bar',
                data: {
                    labels: ['14-15 years', '16-17 years', '18+ years'],
                    datasets: [{
                        data: [ageCounts['14-15'], ageCounts['16-17'], ageCounts['18+']],
                        backgroundColor: ['#667eea', '#764ba2', '#f093fb']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Referral Sources Chart
            const sourceCtx = document.getElementById('sourceChart').getContext('2d');
            const sourceCounts = {};
            filteredData.forEach(r => {
                sourceCounts[r.referralSource] = (sourceCounts[r.referralSource] || 0) + 1;
            });
            const sortedSources = Object.entries(sourceCounts).sort((a, b) => b[1] - a[1]);
            
            charts.source = new Chart(sourceCtx, {
                type: 'bar',
                data: {
                    labels: sortedSources.map(s => s[0]),
                    datasets: [{
                        data: sortedSources.map(s => s[1]),
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Monthly Trend Chart
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            const monthCounts = {};
            filteredData.forEach(r => {
                const date = new Date(convertDate(r.referralDate));
                const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                monthCounts[monthKey] = (monthCounts[monthKey] || 0) + 1;
            });
            
            const sortedMonths = Object.entries(monthCounts).sort();
            
            charts.trend = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: sortedMonths.map(m => m[0]),
                    datasets: [{
                        label: 'Referrals',
                        data: sortedMonths.map(m => m[1]),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateChartsWithFilteredData(filteredData) {
            // Update gender chart
            const genderCounts = { Male: 0, Female: 0, Other: 0 };
            filteredData.forEach(r => genderCounts[r.gender]++);
            charts.gender.data.datasets[0].data = [genderCounts.Male, genderCounts.Female, genderCounts.Other];
            charts.gender.update();

            // Update age chart
            const ageCounts = { '14-15': 0, '16-17': 0, '18+': 0 };
            filteredData.forEach(r => {
                if (r.ageAtReferral <= 15) ageCounts['14-15']++;
                else if (r.ageAtReferral <= 17) ageCounts['16-17']++;
                else ageCounts['18+']++;
            });
            charts.age.data.datasets[0].data = [ageCounts['14-15'], ageCounts['16-17'], ageCounts['18+']];
            charts.age.update();

            // Update source chart
            const sourceCounts = {};
            filteredData.forEach(r => {
                sourceCounts[r.referralSource] = (sourceCounts[r.referralSource] || 0) + 1;
            });
            const sortedSources = Object.entries(sourceCounts).sort((a, b) => b[1] - a[1]);
            charts.source.data.labels = sortedSources.map(s => s[0]);
            charts.source.data.datasets[0].data = sortedSources.map(s => s[1]);
            charts.source.update();

            // Update trend chart
            const monthCounts = {};
            filteredData.forEach(r => {
                const date = new Date(convertDate(r.referralDate));
                const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                monthCounts[monthKey] = (monthCounts[monthKey] || 0) + 1;
            });
            
            const sortedMonths = Object.entries(monthCounts).sort();
            charts.trend.data.labels = sortedMonths.map(m => m[0]);
            charts.trend.data.datasets[0].data = sortedMonths.map(m => m[1]);
            charts.trend.update();
        }

        // Referrals functionality
        function renderReferrals() {
            const grid = document.getElementById('referralsGrid');
            grid.innerHTML = referralData.map(referral => `
                <div class="referral-card">
                    <div class="referral-header">
                        <div class="referral-id">${referral.id}</div>
                        <div class="referral-date">${referral.referralDate}</div>
                    </div>
                    <div class="referral-details">
                        <div class="detail-item">
                            <div class="detail-label">Client Name</div>
                            <div class="detail-value">${referral.clientName}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Age</div>
                            <div class="detail-value">${referral.ageAtReferral} years</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Gender</div>
                            <div class="detail-value">${referral.gender}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Source</div>
                            <div class="detail-value">${referral.referralSource}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Outcome</div>
                            <div class="detail-value">
                                <span class="badge ${referral.referralOutcome.toLowerCase().replace(/\s+/g, '-')}">${referral.referralOutcome}</span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Support</div>
                            <div class="detail-value">
                                <span class="badge ${referral.supportProvided.toLowerCase().replace(/\s+/g, '-')}">${referral.supportProvided}</span>
                            </div>
                        </div>
                    </div>
                    <div class="referral-actions">
                        <button class="btn-secondary" onclick="editReferral('${referral.id}')">Edit</button>
                        <button class="btn-secondary" onclick="showActionForm('${referral.id}')">Action</button>
                        <button class="btn-danger" onclick="deleteReferral('${referral.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function filterReferrals() {
            const searchTerm = document.getElementById('referralSearch').value.toLowerCase();
            const cards = document.querySelectorAll('.referral-card');
            
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        function showNewReferralForm() {
            showReferralModal();
        }

        function editReferral(id) {
            const referral = referralData.find(r => r.id === id);
            showReferralModal(referral);
        }

        function deleteReferral(id) {
            if (confirm('Are you sure you want to delete this referral?')) {
                referralData = referralData.filter(r => r.id !== id);
                renderReferrals();
                updateDashboard();
            }
        }

        function showActionForm(id) {
            const referral = referralData.find(r => r.id === id);
            showActionModal(referral);
        }

        function showReferralModal(referral = null) {
            const isEdit = referral !== null;
            const modalHtml = `
                <div class="modal-overlay" onclick="closeModal(event)">
                    <div class="modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3 class="modal-title">${isEdit ? 'Update Referral' : 'Create Referral'}</h3>
                            <button class="modal-close" onclick="closeModalDirect()">&times;</button>
                        </div>
                        <div class="form-grid">
                            <div class="form-section">
                                <h4 class="form-section-title">üìã Basic Information</h4>
                                <div class="form-row">
                                    <div class="form-field">
                                        <label>Referral Date *</label>
                                        <input type="date" id="referralDate" value="${isEdit ? convertDate(referral.referralDate) : ''}" required>
                                    </div>
                                    <div class="form-field">
                                        <label>C3MS Number *</label>
                                        <input type="text" id="c3msNumber" value="${isEdit ? referral.c3msNumber : ''}" required>
                                    </div>
                                </div>
                            </div>
                            <div class="form-section">
                                <h4 class="form-section-title">üë§ Client Information</h4>
                                <div class="form-row">
                                    <div class="form-field">
                                        <label>Client Name *</label>
                                        <input type="text" id="clientName" value="${isEdit ? referral.clientName : ''}" required>
                                    </div>
                                    <div class="form-field">
                                        <label>Date of Birth *</label>
                                        <input type="date" id="dateOfBirth" value="${isEdit ? convertDate(referral.dateOfBirth) : ''}" onchange="calculateAge()" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-field">
                                        <label>Age at Referral</label>
                                        <input type="number" id="ageAtReferral" value="${isEdit ? referral.ageAtReferral : ''}" disabled style="background: #f5f5f5; color: #999; cursor: not-allowed;">
                                        <small>Automatically calculated</small>
                                    </div>
                                    <div class="form-field">
                                        <label>Gender *</label>
                                        <select id="gender" required>
                                            <option value="">Select gender</option>
                                            <option value="Male" ${isEdit && referral.gender === 'Male' ? 'selected' : ''}>Male</option>
                                            <option value="Female" ${isEdit && referral.gender === 'Female' ? 'selected' : ''}>Female</option>
                                            <option value="Other" ${isEdit && referral.gender === 'Other' ? 'selected' : ''}>Other</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="form-section">
                                <h4 class="form-section-title">üè† Location & Living Situation</h4>
                                <div class="form-row">
                                    <div class="form-field">
                                        <label>Post Code *</label>
                                        <input type="text" id="postCode" value="${isEdit ? referral.postCode : ''}" required>
                                    </div>
                                    <div class="form-field">
                                        <label>Living Arrangement *</label>
                                        <select id="livingArrangement" required>
                                            <option value="">Select arrangement</option>
                                            ${fieldConfig.livingArrangements.map(arr => 
                                                `<option value="${arr}" ${isEdit && referral.livingArrangement === arr ? 'selected' : ''}>${arr}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                </div>
                                <div class="form-field">
                                    <label>NDIS Status *</label>
                                    <select id="ndisStatus" required>
                                        <option value="">Select status</option>
                                        <option value="Yes" ${isEdit && referral.ndisStatus === 'Yes' ? 'selected' : ''}>Yes</option>
                                        <option value="No" ${isEdit && referral.ndisStatus === 'No' ? 'selected' : ''}>No</option>
                                        <option value="Unknown" ${isEdit && referral.ndisStatus === 'Unknown' ? 'selected' : ''}>Unknown</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-section">
                                <h4 class="form-section-title">üìû Referral Details</h4>
                                <div class="form-row">
                                    <div class="form-field">
                                        <label>Referral Source *</label>
                                        <select id="referralSource" required>
                                            <option value="">Select source</option>
                                            ${fieldConfig.referralSources.map(source => 
                                                `<option value="${source}" ${isEdit && referral.referralSource === source ? 'selected' : ''}>${source}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                    <div class="form-field">
                                        <label>YJ Involvement *</label>
                                        <select id="yjInvolvement" required>
                                            <option value="">Select involvement</option>
                                            ${fieldConfig.yjInvolvement.map(involvement => 
                                                `<option value="${involvement}" ${isEdit && referral.yjInvolvement === involvement ? 'selected' : ''}>${involvement}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-field">
                                        <label>Referral Outcome *</label>
                                        <select id="referralOutcome" required>
                                            <option value="">Select outcome</option>
                                            ${fieldConfig.referralOutcomes.map(outcome => 
                                                `<option value="${outcome}" ${isEdit && referral.referralOutcome === outcome ? 'selected' : ''}>${outcome}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                    <div class="form-field">
                                        <label>Support Provided *</label>
                                        <select id="supportProvided" required>
                                            <option value="">Select support</option>
                                            ${fieldConfig.supportProvided.map(support => 
                                                `<option value="${support}" ${isEdit && referral.supportProvided === support ? 'selected' : ''}>${support}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button class="btn-cancel" onclick="closeModalDirect()">Cancel</button>
                            <button class="btn-primary" onclick="saveReferral(${isEdit ? `'${referral.id}'` : 'null'})">${isEdit ? 'Update' : 'Create'} Referral</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function showActionModal(referral) {
            const modalHtml = `
                <div class="modal-overlay" onclick="closeModal(event)">
                    <div class="modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3 class="modal-title">Process Action - ${referral.id}</h3>
                            <button class="modal-close" onclick="closeModalDirect()">&times;</button>
                        </div>
                        <div class="form-section">
                            <h4 class="form-section-title">üë§ Client Information</h4>
                            <div class="form-row">
                                <div class="form-field">
                                    <label>Client Name</label>
                                    <input type="text" value="${referral.clientName}" disabled>
                                </div>
                                <div class="form-field">
                                    <label>Age</label>
                                    <input type="text" value="${referral.ageAtReferral} years" disabled>
                                </div>
                            </div>
                        </div>
                        <div class="form-section">
                            <h4 class="form-section-title">üìÖ Event Details</h4>
                            <div class="form-row">
                                <div class="form-field">
                                    <label>Event Date *</label>
                                    <input type="date" id="eventDate" required>
                                </div>
                                <div class="form-field">
                                    <label>Event Type *</label>
                                    <select id="eventType" required>
                                        <option value="">Select event type</option>
                                        <option value="Activated">Activated</option>
                                        <option value="Transport to country">Transport to country</option>
                                        <option value="Metro transport">Metro transport</option>
                                        <option value="Family Scoping and transport">Family Scoping and transport</option>
                                        <option value="Family scoping only">Family scoping only</option>
                                        <option value="Supplementary support">Supplementary support</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-field">
                                    <label>Case Status *</label>
                                    <select id="caseStatus" onchange="toggleClosureDate()" required>
                                        <option value="">Select status</option>
                                        <option value="Open">Open</option>
                                        <option value="Closed">Closed</option>
                                    </select>
                                </div>
                                <div class="form-field">
                                    <label>Case Closure Date</label>
                                    <input type="date" id="closureDate" disabled style="background: #f5f5f5; color: #999;">
                                    <small>Only available when case status is "Closed"</small>
                                </div>
                            </div>
                            <div class="form-field">
                                <label>Notes</label>
                                <textarea id="eventNotes" rows="3" placeholder="Enter any additional notes..."></textarea>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button class="btn-cancel" onclick="closeModalDirect()">Cancel</button>
                            <button class="btn-primary" onclick="saveAction('${referral.id}')">Save Action</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function toggleClosureDate() {
            const caseStatus = document.getElementById('caseStatus').value;
            const closureDate = document.getElementById('closureDate');
            
            if (caseStatus === 'Closed') {
                closureDate.disabled = false;
                closureDate.style.background = 'white';
                closureDate.style.color = '#333';
                closureDate.style.cursor = 'text';
            } else {
                closureDate.disabled = true;
                closureDate.style.background = '#f5f5f5';
                closureDate.style.color = '#999';
                closureDate.style.cursor = 'not-allowed';
                closureDate.value = '';
            }
        }

        function saveReferral(editId) {
            const formData = {
                referralDate: formatDate(document.getElementById('referralDate').value),
                c3msNumber: document.getElementById('c3msNumber').value,
                clientName: document.getElementById('clientName').value,
                dateOfBirth: formatDate(document.getElementById('dateOfBirth').value),
                ageAtReferral: parseInt(document.getElementById('ageAtReferral').value),
                gender: document.getElementById('gender').value,
                postCode: document.getElementById('postCode').value,
                livingArrangement: document.getElementById('livingArrangement').value,
                ndisStatus: document.getElementById('ndisStatus').value,
                referralSource: document.getElementById('referralSource').value,
                yjInvolvement: document.getElementById('yjInvolvement').value,
                referralOutcome: document.getElementById('referralOutcome').value,
                supportProvided: document.getElementById('supportProvided').value
            };

            if (editId) {
                // Update existing referral
                const index = referralData.findIndex(r => r.id === editId);
                referralData[index] = { ...referralData[index], ...formData };
            } else {
                // Create new referral
                const newId = `REF-${String(referralData.length + 1).padStart(4, '0')}`;
                referralData.push({
                    id: newId,
                    ...formData,
                    events: []
                });
            }

            closeModalDirect();
            renderReferrals();
            updateDashboard();
        }

        function saveAction(referralId) {
            const eventData = {
                date: formatDate(document.getElementById('eventDate').value),
                type: document.getElementById('eventType').value,
                status: document.getElementById('caseStatus').value,
                notes: document.getElementById('eventNotes').value
            };

            if (eventData.status === 'Closed') {
                eventData.closureDate = formatDate(document.getElementById('closureDate').value);
            }

            const referral = referralData.find(r => r.id === referralId);
            if (!referral.events) referral.events = [];
            referral.events.push(eventData);

            closeModalDirect();
            renderReferrals();
        }

        // Modal close functions - FIXED
        function closeModal(event) {
            if (event && event.target && !event.target.classList.contains('modal-overlay')) {
                return;
            }
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
        }

        function closeModalDirect() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
        }

        // AI Assistant functionality
        let chatHistory = [];

        function askQuestion(question) {
            document.getElementById('chatInput').value = question;
            sendMessage();
        }

        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addMessageToChat(message, 'user');
            
            // Clear input
            input.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            // Disable send button
            const sendBtn = document.getElementById('chatSendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Thinking...';
            
            try {
                // Get AI response
                const response = await getAIResponse(message);
                
                // Remove typing indicator
                hideTypingIndicator();
                
                // Add AI response to chat
                addMessageToChat(response, 'ai');
                
            } catch (error) {
                hideTypingIndicator();
                addMessageToChat('Sorry, I encountered an error while processing your request. Please try again.', 'ai');
            } finally {
                // Re-enable send button
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send';
            }
        }

        function addMessageToChat(message, sender) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            messageDiv.innerHTML = `
                <div>${message}</div>
                <div class="message-time">${timeString}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Store in chat history
            chatHistory.push({
                message: message,
                sender: sender,
                timestamp: now
            });
        }

        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        async function getAIResponse(userMessage) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Use filtered data for AI responses
            const filteredData = getFilteredData();
            const lowerMessage = userMessage.toLowerCase();
            
            if (lowerMessage.includes('how many') && lowerMessage.includes('referral')) {
                return `Based on your current data, you have ${filteredData.length} referrals in your system. Here's a quick breakdown:
                
‚Ä¢ Total referrals: ${filteredData.length}
‚Ä¢ Accepted: ${filteredData.filter(r => r.referralOutcome === 'Accepted').length}
‚Ä¢ From SAPOL: ${filteredData.filter(r => r.referralSource === 'SAPOL').length}
‚Ä¢ Average client age: ${Math.round(filteredData.reduce((sum, r) => sum + r.ageAtReferral, 0) / filteredData.length)} years`;
            }
            
            if (lowerMessage.includes('age') && lowerMessage.includes('breakdown')) {
                const ageGroups = {
                    '14-15': filteredData.filter(r => r.ageAtReferral >= 14 && r.ageAtReferral <= 15).length,
                    '16-17': filteredData.filter(r => r.ageAtReferral >= 16 && r.ageAtReferral <= 17).length,
                    '18+': filteredData.filter(r => r.ageAtReferral >= 18).length
                };
                
                return `Here's the age breakdown of your clients:

‚Ä¢ 14-15 years: ${ageGroups['14-15']} clients (${Math.round(ageGroups['14-15']/filteredData.length*100)}%)
‚Ä¢ 16-17 years: ${ageGroups['16-17']} clients (${Math.round(ageGroups['16-17']/filteredData.length*100)}%)
‚Ä¢ 18+ years: ${ageGroups['18+']} clients (${Math.round(ageGroups['18+']/filteredData.length*100)}%)

The majority of your clients are in the 16-17 age group.`;
            }
            
            if (lowerMessage.includes('referral source') || lowerMessage.includes('most common')) {
                const sources = {};
                filteredData.forEach(r => {
                    sources[r.referralSource] = (sources[r.referralSource] || 0) + 1;
                });
                
                const sortedSources = Object.entries(sources).sort((a, b) => b[1] - a[1]);
                
                let response = "Here are your referral sources ranked by frequency:\n\n";
                sortedSources.forEach(([source, count], index) => {
                    const percentage = Math.round(count/filteredData.length*100);
                    response += `${index + 1}. ${source}: ${count} referrals (${percentage}%)\n`;
                });
                
                return response;
            }
            
            if (lowerMessage.includes('support type') || lowerMessage.includes('support provided')) {
                const supports = {};
                filteredData.forEach(r => {
                    supports[r.supportProvided] = (supports[r.supportProvided] || 0) + 1;
                });
                
                const sortedSupports = Object.entries(supports).sort((a, b) => b[1] - a[1]);
                
                let response = "Here are the support types provided, ranked by frequency:\n\n";
                sortedSupports.forEach(([support, count], index) => {
                    const percentage = Math.round(count/filteredData.length*100);
                    response += `${index + 1}. ${support}: ${count} cases (${percentage}%)\n`;
                });
                
                return response;
            }
            
            if (lowerMessage.includes('average age')) {
                const avgAge = Math.round(filteredData.reduce((sum, r) => sum + r.ageAtReferral, 0) / filteredData.length * 10) / 10;
                return `The average age of your clients at referral is ${avgAge} years.
                
Additional age statistics:
‚Ä¢ Youngest client: ${Math.min(...filteredData.map(r => r.ageAtReferral))} years
‚Ä¢ Oldest client: ${Math.max(...filteredData.map(r => r.ageAtReferral))} years`;
            }
            
            if (lowerMessage.includes('open') && lowerMessage.includes('closed')) {
                // This would require event data analysis
                return `Based on your referral data, I can see the referral outcomes, but to provide accurate open vs closed case statistics, I would need to analyze the event data for each referral. 

From the referral outcomes I can see:
‚Ä¢ Accepted referrals: ${filteredData.filter(r => r.referralOutcome === 'Accepted').length}
‚Ä¢ Criteria not met: ${filteredData.filter(r => r.referralOutcome === 'Criteria not Met').length}
‚Ä¢ Referred to other agencies: ${filteredData.filter(r => r.referralOutcome === 'Referred to Other Agencies').length}
‚Ä¢ Not progressed: ${filteredData.filter(r => r.referralOutcome === 'Referral not progressed').length}`;
            }
            
            // Default response
            return `I understand you're asking about "${userMessage}". I can help you analyze your referral data in many ways. Here are some things I can tell you about:

‚Ä¢ Demographics (age, gender, location)
‚Ä¢ Referral sources and outcomes  
‚Ä¢ Support types provided
‚Ä¢ Trends and patterns in your data
‚Ä¢ Specific statistics and breakdowns

Could you please rephrase your question or ask about one of these specific areas?`;
        }

        // Client Matrix functionality
        function renderClientMatrix() {
            const tableBody = document.getElementById('clientTableBody');
            tableBody.innerHTML = referralData.map(referral => `
                <tr>
                    <td>${referral.id}</td>
                    <td>${referral.referralDate}</td>
                    <td>${referral.clientName}</td>
                    <td>${referral.ageAtReferral}</td>
                    <td>${referral.gender}</td>
                    <td>${referral.postCode}</td>
                    <td>${referral.livingArrangement}</td>
                    <td>${referral.ndisStatus}</td>
                    <td>${referral.referralSource}</td>
                    <td>${referral.yjInvolvement}</td>
                    <td>${referral.referralOutcome}</td>
                    <td>${referral.supportProvided}</td>
                </tr>
            `).join('');
        }

        function exportToExcel() {
            const ws = XLSX.utils.json_to_sheet(referralData.map(r => ({
                'Referral ID': r.id,
                'Referral Date': r.referralDate,
                'C3MS Number': r.c3msNumber,
                'Client Name': r.clientName,
                'Date of Birth': r.dateOfBirth,
                'Age at Referral': r.ageAtReferral,
                'Gender': r.gender,
                'Post Code': r.postCode,
                'Living Arrangement': r.livingArrangement,
                'NDIS Status': r.ndisStatus,
                'Referral Source': r.referralSource,
                'YJ Involvement': r.yjInvolvement,
                'Referral Outcome': r.referralOutcome,
                'Support Provided': r.supportProvided
            })));
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'CDP Referrals');
            XLSX.writeFile(wb, 'CDP_Referrals_Export.xlsx');
        }

        function exportToCSV() {
            const headers = ['Referral ID', 'Referral Date', 'C3MS Number', 'Client Name', 'Date of Birth', 'Age at Referral', 'Gender', 'Post Code', 'Living Arrangement', 'NDIS Status', 'Referral Source', 'YJ Involvement', 'Referral Outcome', 'Support Provided'];
            
            const csvContent = [
                headers.join(','),
                ...referralData.map(r => [
                    r.id,
                    r.referralDate,
                    r.c3msNumber,
                    `"${r.clientName}"`,
                    r.dateOfBirth,
                    r.ageAtReferral,
                    r.gender,
                    r.postCode,
                    `"${r.livingArrangement}"`,
                    r.ndisStatus,
                    `"${r.referralSource}"`,
                    `"${r.yjInvolvement}"`,
                    `"${r.referralOutcome}"`,
                    `"${r.supportProvided}"`
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'CDP_Referrals_Export.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Settings functionality
        function renderSettings() {
            Object.keys(fieldConfig).forEach(category => {
                const container = document.getElementById(`${category}Values`);
                if (container) {
                    container.innerHTML = fieldConfig[category].map(value => `
                        <div class="field-value-item">
                            <span>${value}</span>
                            <div class="field-value-actions">
                                <button class="field-action-btn" onclick="editFieldValue('${category}', '${value}')">‚úèÔ∏è</button>
                                <button class="field-action-btn delete" onclick="deleteFieldValue('${category}', '${value}')">üóëÔ∏è</button>
                            </div>
                        </div>
                    `).join('');
                }
            });
        }

        function addFieldValue() {
            const category = document.getElementById('fieldCategory').value;
            const newValue = document.getElementById('newFieldValue').value.trim();
            
            if (newValue && !fieldConfig[category].includes(newValue)) {
                fieldConfig[category].push(newValue);
                renderSettings();
                document.getElementById('newFieldValue').value = '';
            }
        }

        function addNewField() {
            const fieldName = document.getElementById('newFieldName').value.trim();
            const fieldType = document.getElementById('newFieldType').value;
            
            if (fieldName) {
                alert(`New ${fieldType} field "${fieldName}" would be added to the system. This feature requires backend implementation.`);
                document.getElementById('newFieldName').value = '';
            }
        }

        function editFieldValue(category, value) {
            const newValue = prompt(`Edit value:`, value);
            if (newValue && newValue !== value) {
                const index = fieldConfig[category].indexOf(value);
                fieldConfig[category][index] = newValue;
                renderSettings();
            }
        }

        function deleteFieldValue(category, value) {
            if (confirm(`Are you sure you want to delete "${value}"?`)) {
                fieldConfig[category] = fieldConfig[category].filter(v => v !== value);
                renderSettings();
            }
        }
    </script>
</body>
</html>

